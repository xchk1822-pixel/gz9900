<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>ä¸­å›½å¹´é¤å…è–ªèµ„ç®¡ç†ç³»ç»Ÿ - ç»ˆæå®‰å…¨ç‰ˆ</title>
    <style>
        /* Mantengo tus estilos originales para no alterar el diseÃ±o */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 20px; background-color: #f0f2f5; color: #333; }
        .container { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); max-width: 1100px; margin: auto; }
        .header-box { text-align: center; border-bottom: 3px double #b71c1c; margin-bottom: 25px; padding-bottom: 10px; }
        .header-box h1 { margin: 0; color: #b71c1c; font-size: 26px; }
        .header-box p { margin: 5px 0; color: #666; font-weight: bold; }
        .btn-group { text-align: right; margin-bottom: 20px; }
        .btn { padding: 8px 12px; cursor: pointer; border: none; border-radius: 6px; font-weight: bold; font-size: 11px; margin-left: 5px; }
        .btn-unlock { background: #455a64; color: white; }
        .btn-add { background: #2e7d32; color: white; }
        .btn-backup { background: #fb8c00; color: white; }
        .btn-restore { background: #8e24aa; color: white; }
        .btn-print { background: #1565c0; color: white; }
        .btn-danger { background: #d32f2f; color: white; }
        .row-normal { background-color: #ffffff; }
        .row-empty { background-color: #fff3e0 !important; } 
        .row-off { background-color: #e3f2fd !important; }    
        .row-absent { background-color: #ffebee !important; }  
        .lock-status { font-size: 12px; margin-right: 10px; font-weight: bold; }
        .status-locked { color: #c62828; }
        .status-unlocked { color: #2e7d32; }
        #passwordModal {
            display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.6); align-items: center; justify-content: center;
        }
        .modal-content { background: white; padding: 25px; border-radius: 12px; width: 320px; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .modal-content input { width: 80%; padding: 10px; margin: 15px 0; border: 1px solid #ddd; border-radius: 6px; font-size: 20px; text-align: center; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; background: white; font-size: 12px; table-layout: fixed; }
        th, td { border: 1px solid #dee2e6; padding: 8px 2px; text-align: center; overflow: hidden; }
        th { background-color: #f8f9fa; color: #555; font-size: 11px; height: 40px; }
        .individual-config { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; background: #e8f5e9; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #c8e6c9; }
        .config-item { display: flex; flex-direction: column; font-size: 11px; font-weight: bold; }
        .config-item label { color: #2e7d32; margin-bottom: 4px; }
        .btn-punch { padding: 4px 8px; font-size: 10px; cursor: pointer; background: #b71c1c; color: white; border: none; border-radius: 4px; margin-top: 2px; }
        .btn-punch:disabled { background: #ccc !important; cursor: not-allowed; opacity: 0.6; }
        input[type="checkbox"]:disabled { cursor: not-allowed; opacity: 0.8; }
        input[readonly] { background-color: #f9f9f9; border: 1px solid #ddd; color: #333; text-align: center; width: 45px; font-weight: bold; }
        .emp-stat-box { margin-top: 15px; padding: 15px; background: #fdfdfd; border: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; border-radius: 6px; }
        .signature-row { margin-top: 30px; display: flex; justify-content: flex-end; }
        .signature-line { border-top: 1.5px solid #333; width: 220px; text-align: center; font-size: 11px; font-weight: bold; padding-top: 5px; }
        .summary-area { margin-top: 50px; page-break-before: always; border-top: 3px solid #b71c1c; padding-top: 20px; }
        @media print {
            .no-print, .btn-punch, #passwordModal { display: none !important; }
            .page-break { page-break-after: always; border-bottom: 1px dashed #ccc; margin-bottom: 30px; }
            .container { box-shadow: none; padding: 0; }
        }
    </style>
</head>
<body>

<div id="passwordModal">
    <div class="modal-content">
        <h3 style="margin:0">è®¤è¯ / AutenticaciÃ³n</h3>
        <p style="font-size:11px; color:#666;">è¯·è¾“å…¥ç®¡ç†å¯†ç  / ContraseÃ±a</p >
        <input type="password" id="adminPassInput" placeholder="******" onkeydown="if(event.keyCode==13) verifyPassword()">
        <div style="display:flex; justify-content: space-around;">
            <button class="btn btn-danger" onclick="closeModal()">å–æ¶ˆ / Cancelar</button>
            <button class="btn btn-add" onclick="verifyPassword()">ç¡®è®¤ / OK</button>
        </div>
    </div>
</div>

<div class="container">
    <div class="header-box">
        <h1>ä¸­å›½å¹´é¤å…è–ªèµ„ç®¡ç†ç³»ç»Ÿ</h1>
        <p>Sistema de NÃ³mina - Restaurante China Yearly</p >
    </div>

    <div class="btn-group no-print">
        <span id="lockStatusDisplay" class="lock-status status-locked">ğŸ”’ å·²é”å®š / Bloqueado</span>
        <button id="unlockBtn" class="btn btn-unlock" onclick="openModal()">ğŸ”‘ ç®¡ç†å‘˜è§£é” / Desbloquear</button>
        <button class="btn btn-add" onclick="addEmployee()">+ æ·»åŠ å‘˜å·¥ / Agregar</button>
        <button class="btn btn-backup" onclick="exportData()">ğŸ’¾ æ‰‹åŠ¨å¤‡ä»½ / Exportar</button>
        <button class="btn btn-restore" onclick="triggerRestore()">ğŸ“‚ æ¢å¤æ–‡ä»¶ / Importar</button>
        <input type="file" id="importFile" style="display:none" accept=".json" onchange="importData(this)">
        <button class="btn btn-print" onclick="window.print()">ğŸ–¨ï¸ æ‰“å°å·¥èµ„å• / Imprimir</button>
        <button class="btn btn-danger" onclick="clearAllData()">âš ï¸ æ¸…ç©ºå…¨éƒ¨ / Limpiar</button>
    </div>

    <div id="employees-content"></div>

    <div class="summary-area">
        <h2 style="border-left: 5px solid #b71c1c; padding-left:10px;">å…¨å‘˜æ±‡æ€»è¡¨ / Resumen General</h2>
        <table>
            <thead>
                <tr style="background:#333; color:white;">
                    <th style="width:15%">å§“å / Nombre</th>
                    <th style="width:20%">å‡ºå‹¤å¤©æ•° / DÃ­as (T/L/A)</th>
                    <th style="width:15%">åŸºæœ¬å·¥èµ„ / Base</th>
                    <th style="width:15%">åŠ ç­è´¹ / Extras</th>
                    <th style="width:15%">ç¦åˆ© / Bonos</th>
                    <th style="width:20%">æ€»è®¡åˆè®¡ / Total</th>
                </tr>
            </thead>
            <tbody id="summary-body"></tbody>
            <tfoot>
                <tr style="background:#fff9c4; font-weight:bold; font-size: 14px;">
                    <td colspan="2" style="text-align: right;">å…¨åº—åˆè®¡ / GRAN TOTAL:</td>
                    <td id="total-base">C$ 0.00</td><td id="total-extras">C$ 0.00</td><td id="total-bonos">C$ 0.00</td><td id="total-all" style="color:#b71c1c;">C$ 0.00</td>
                </tr>
            </tfoot>
        </table>
    </div>
</div>

<script>
    const ADMIN_PASSWORD = "123456"; 
    const DB_NAME = 'rest_salary_complete_v6';
    const BACKUP_NAME = 'rest_salary_backup';
    let isUnlocked = false; 
    let employees = [];

    // --- MEJORA: Sistema de Carga con Auto-RecuperaciÃ³n ---
    function loadData() {
        const mainData = localStorage.getItem(DB_NAME);
        const backupData = localStorage.getItem(BACKUP_NAME);

        if (mainData) {
            employees = JSON.parse(mainData);
        } else if (backupData) {
            // Si el principal fallÃ³ pero hay backup, recuperar automÃ¡ticamente
            if (confirm("âš ï¸ æ£€æµ‹åˆ°ä¸»æ•°æ®ä¸¢å¤±ï¼Œæ˜¯å¦ä»è‡ªåŠ¨å¤‡ä»½ä¸­æ¢å¤ï¼Ÿ\nSe detectÃ³ pÃ©rdida de datos, Â¿restaurar desde backup automÃ¡tico?")) {
                employees = JSON.parse(backupData);
                saveData();
            }
        } else {
            employees = [];
        }
    }

    // --- MEJORA: Guardado AtÃ³mico y Doble Copia ---
    function saveData() {
        if (!employees) return;
        const dataStr = JSON.stringify(employees);
        
        // No guardar si el array estÃ¡ vacÃ­o para evitar borrar datos accidentalmente
        // (A menos que se use la funciÃ³n clearAllData explÃ­citamente)
        localStorage.setItem(DB_NAME, dataStr);
        
        // Crear copia de seguridad en otro slot de memoria
        if (employees.length > 0) {
            localStorage.setItem(BACKUP_NAME, dataStr);
        }
    }

    function openModal() {
        if (isUnlocked) { isUnlocked = false; updateLockUI(); alert("å·²é€€å‡ºç®¡ç†æ¨¡å¼ / Modo Admin Cerrado"); render(); } 
        else { document.getElementById('passwordModal').style.display = 'flex'; document.getElementById('adminPassInput').focus(); }
    }
    function closeModal() { document.getElementById('passwordModal').style.display = 'none'; }
    function verifyPassword() {
        if (document.getElementById('adminPassInput').value === ADMIN_PASSWORD) { isUnlocked = true; updateLockUI(); closeModal(); render(); } 
        else { alert("å¯†ç é”™è¯¯ / Incorrecto"); }
    }
    function updateLockUI() {
        const s = document.getElementById('lockStatusDisplay');
        const b = document.getElementById('unlockBtn');
        s.innerHTML = isUnlocked ? "ğŸ”“ ç®¡ç†æ¨¡å¼ / Modo Admin" : "ğŸ”’ å·²é”å®š / Bloqueado";
        s.className = isUnlocked ? "lock-status status-unlocked" : "lock-status status-locked";
        b.innerHTML = isUnlocked ? "ğŸ”’ é€€å‡ºç®¡ç† / Salir" : "ğŸ”‘ ç®¡ç†å‘˜è§£é” / Desbloquear";
    }

    function checkPermission() { if (!isUnlocked) alert("éœ€è¦ç®¡ç†å‘˜æƒé™ / Requiere Admin"); return isUnlocked; }

    function doPunch(empId, dayIdx, field) {
        const emp = employees.find(e => e.id === empId);
        if (!emp.records[dayIdx]) emp.records[dayIdx] = { s:'', e:'', off:false, abs:false, b:0 };
        if (!isUnlocked && emp.records[dayIdx][field]) { alert("ä¸å¯ä¿®æ”¹ / No se puede modificar"); return; }
        
        const now = new Date();
        const t = `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
        emp.records[dayIdx][field] = t;
        saveData(); render();
    }

    function addEmployee() {
        if (!checkPermission()) return;
        const n = prompt("è¾“å…¥å‘˜å·¥å§“å / Nombre:");
        if (n) { employees.push({ id: Date.now(), name: n, startDate: new Date().toISOString().split('T')[0], days: 15, dailyRate: 500, otRate: 60, records: {} }); saveData(); render(); }
    }

    function updateConfig(id, f, v) { 
        if (!isUnlocked) { render(); return; } 
        const emp = employees.find(e => e.id === id); 
        if (emp) { emp[f] = v; saveData(); render(); } 
    }
    
    function updateState(empId, dayIdx, field, val) {
        const emp = employees.find(e => e.id === empId);
        if (!emp.records[dayIdx]) emp.records[dayIdx] = { s:'', e:'', off:false, abs:false, b:0 };
        const r = emp.records[dayIdx];

        if (!isUnlocked) {
            if (field === 'b') { render(); return; }
            if (r[field] === true && val === false) { alert("å·²é”å®š / Bloqueado"); render(); return; }
        }

        if (field === 'off' && val === true) r.abs = false;
        if (field === 'abs' && val === true) r.off = false;
        r[field] = val;
        saveData(); render();
    }

    function calculateHours(s, e) {
        if(!s || !e) return 0;
        let d1 = new Date(`2000-01-01T${s}`), d2 = new Date(`2000-01-01T${e}`);
        if (d2 < d1) d2.setDate(d2.getDate() + 1);
        return (d2 - d1) / 3600000;
    }

    function render() {
        const list = document.getElementById('employees-content');
        list.innerHTML = ""; 
        let gBase=0, gExtras=0, gBonos=0, gAll=0, summaryHtml = "";

        employees.forEach(emp => {
            const sDate = new Date(emp.startDate + "T00:00:00");
            let rowsHtml = "";
            let eBase=0, eExtras=0, eBonos=0, dT=0, dL=0, dA=0;

            for(let d=0; d<emp.days; d++){
                const rec = emp.records[d] || { s:'', e:'', off:false, abs:false, b:0 };
                let cur = new Date(sDate); cur.setDate(sDate.getDate() + d);
                let wh=0, oh=0, pay=0, rowCls="row-normal";

                if (rec.abs) { rowCls="row-absent"; dA++; pay = parseFloat(rec.b || 0); } 
                else if (rec.off) { rowCls="row-off"; dL++; eBase += parseFloat(emp.dailyRate); pay = parseFloat(emp.dailyRate) + parseFloat(rec.b || 0); } 
                else {
                    dT++; eBase += parseFloat(emp.dailyRate);
                    if (rec.s && rec.e) { wh = calculateHours(rec.s, rec.e); oh = Math.max(0, wh - 9); eExtras += (oh * parseFloat(emp.otRate)); }
                    else { rowCls = "row-empty"; } 
                    pay = parseFloat(emp.dailyRate) + (oh * parseFloat(emp.otRate)) + parseFloat(rec.b || 0);
                }
                eBonos += parseFloat(rec.b || 0);

                const isOffOrAbs = (rec.off || rec.abs);
                const checkLock = !isUnlocked && (isOffOrAbs || rec.s !== "" || rec.e !== "");
                const sPunchLock = !isUnlocked && (rec.s !== "" || isOffOrAbs);
                const ePunchLock = !isUnlocked && (rec.e !== "" || isOffOrAbs);

                rowsHtml += `<tr class="${rowCls}">
                    <td><b>${cur.getMonth()+1}/${cur.getDate()}</b></td>
                    <td><input type="checkbox" ${rec.off?'checked':''} ${checkLock?'disabled':''} onchange="updateState(${emp.id},${d},'off',this.checked)"> ä¼‘/L</td>
                    <td><input type="checkbox" ${rec.abs?'checked':''} ${checkLock?'disabled':''} onchange="updateState(${emp.id},${d},'abs',this.checked)"> ç¼º/A</td>
                    <td><input type="text" value="${rec.s}" readonly><button class="btn-punch no-print" ${sPunchLock?'disabled':''} onclick="doPunch(${emp.id},${d},'s')">å…¥/Ent.</button></td>
                    <td><input type="text" value="${rec.e}" readonly><button class="btn-punch no-print" ${ePunchLock?'disabled':''} onclick="doPunch(${emp.id},${d},'e')">å‡º/Sal.</button></td>
                    <td>${wh.toFixed(1)}h</td><td>${oh.toFixed(1)}h</td>
                    <td><input type="number" value="${rec.b}" style="width:40px" ${!isUnlocked?'disabled':''} onchange="updateState(${emp.id},${d},'b',this.value)"></td>
                    <td style="font-weight:bold;">C$ ${pay.toFixed(2)}</td>
                </tr>`;
            }

            const total = eBase + eExtras + eBonos;
            gBase+=eBase; gExtras+=eExtras; gBonos+=eBonos; gAll+=total;

            summaryHtml += `<tr><td><b>${emp.name}</b></td><td>${dT}T / ${dL}L / ${dA}A</td><td>C$ ${eBase.toFixed(2)}</td><td>C$ ${eExtras.toFixed(2)}</td><td>C$ ${eBonos.toFixed(2)}</td><td style="font-weight:bold;">C$ ${total.toFixed(2)}</td></tr>`;

            list.innerHTML += `<div class="page-break">
                <h3 style="color:#1565c0; border-bottom:2px solid #1565c0; margin-top:20px;">${emp.name} - å·¥èµ„æ˜ç»† / Recibo de Pago</h3>
                <div class="individual-config no-print">
                    <div class="config-item"><label>å¼€å§‹æ—¥æœŸ / Inicio:</label><input type="date" value="${emp.startDate}" ${isUnlocked?'':'readonly'} onchange="updateConfig(${emp.id},'startDate',this.value)"></div>
                    <div class="config-item"><label>ç»“ç®—å¤©æ•° / DÃ­as:</label><input type="number" value="${emp.days}" ${isUnlocked?'':'readonly'} onchange="updateConfig(${emp.id},'days',this.value)"></div>
                    <div class="config-item"><label>æ—¥è–ª / Salario Diario:</label><input type="number" value="${emp.dailyRate}" ${isUnlocked?'':'readonly'} onchange="updateConfig(${emp.id},'dailyRate',this.value)"></div>
                    <div class="config-item"><label>åŠ ç­æ—¶è–ª / Hora Extra:</label><input type="number" value="${emp.otRate}" ${isUnlocked?'':'readonly'} onchange="updateConfig(${emp.id},'otRate',this.value)"></div>
                    <button class="btn btn-danger" onclick="removeEmployee(${emp.id})" style="height:30px; margin-top:15px; display:${isUnlocked?'block':'none'}">åˆ é™¤å‘˜å·¥ / Borrar</button>
                </div>
                <table><thead><tr>
                    <th style="width:10%">æ—¥æœŸ/Fecha</th><th style="width:8%">ä¼‘/Libre</th><th style="width:8%">ç¼º/Ausen</th>
                    <th style="width:18%">å…¥/Entrada</th><th style="width:18%">å‡º/Salida</th><th style="width:8%">å·¥æ—¶/H</th>
                    <th style="width:8%">åŠ ç­/Ex</th><th style="width:10%">ç¦åˆ©/Bono</th><th style="width:12%">å°è®¡/Sub</th>
                </tr></thead>
                <tbody>${rowsHtml}</tbody></table>
                <div class="emp-stat-box">
                    <div style="font-size:12px; color:#555;">Base: C$ ${eBase.toFixed(2)} | Extras: C$ ${eExtras.toFixed(2)} | Bono: C$ ${eBonos.toFixed(2)}</div>
                    <div style="font-size:18px; color:#b71c1c; font-weight:bold;">TOTAL: C$ ${total.toFixed(2)}</div>
                </div>
                <div class="signature-row"><div class="signature-line">Firma del Empleado (å‘˜å·¥ç­¾å)</div></div>
            </div>`;
        });
        document.getElementById('summary-body').innerHTML = summaryHtml;
        document.getElementById('total-base').innerText = "C$ " + gBase.toFixed(2);
        document.getElementById('total-extras').innerText = "C$ " + gExtras.toFixed(2);
        document.getElementById('total-bonos').innerText = "C$ " + gBonos.toFixed(2);
        document.getElementById('total-all').innerText = "C$ " + gAll.toFixed(2);
    }

    function removeEmployee(id) { if (checkPermission() && confirm("ç¡®å®šåˆ é™¤ï¼Ÿ")) { employees = employees.filter(e => e.id !== id); saveData(); render(); } }
    
    function clearAllData() { 
        if (checkPermission() && confirm("âš ï¸ ç¡®å®šæ¸…ç©ºæ‰€æœ‰æ•°æ®ï¼Ÿè¿™å°†åŒæ—¶æ¸…é™¤å¤‡ä»½ï¼")) { 
            employees = []; 
            localStorage.removeItem(DB_NAME);
            localStorage.removeItem(BACKUP_NAME);
            render(); 
        } 
    }

    function exportData() {
        if (employees.length === 0) { alert("æ²¡æœ‰æ•°æ®å¯ä»¥å¤‡ä»½ / No hay datos"); return; }
        const d = JSON.stringify(employees);
        const b = new Blob([d], {type: "application/json"});
        const a = document.createElement("a");
        a.href = URL.createObjectURL(b);
        a.download = `Nomina_ChinaYearly_BACKUP_${new Date().toISOString().split('T')[0]}.json`;
        a.click();
    }

    function triggerRestore() { if(checkPermission()) document.getElementById('importFile').click(); }
    
    function importData(i) {
        const r = new FileReader();
        r.onload = (e) => { 
            try { 
                const temp = JSON.parse(e.target.result); 
                if (Array.isArray(temp)) {
                    employees = temp;
                    saveData(); 
                    render(); 
                    alert("æ¢å¤æˆåŠŸ / Restaurado"); 
                } else {
                    throw new Error();
                }
            } catch(err) { 
                alert("æ–‡ä»¶æ ¼å¼ä¸æ­£ç¡® / Formato de archivo invÃ¡lido"); 
            } 
        };
        r.readAsText(i.files[0]);
    }

    window.onload = () => {
        loadData();
        render();
    };
</script>
</body>
</html>